<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>TrackTx ‚Äî Configuration Generator</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">

  <!-- Bulma for clean, aligned UI -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@0.9.4/css/bulma.min.css">
  <!-- JSZip for creating the ZIP with YAML+CSV -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js" crossorigin="anonymous"></script>

  <style>
    /* Improved spacing and readability */
    .small-input{max-width:260px}
    .mono{font-family: ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono",monospace}
    .is-dim{opacity:.85}
    .mb-2{margin-bottom:.5rem}.mb-3{margin-bottom:.75rem}.mb-4{margin-bottom:1rem}.mb-5{margin-bottom:1.5rem}
    .mt-2{margin-top:.5rem}.mt-3{margin-top:.75rem}.mt-4{margin-top:1rem}.mt-5{margin-top:1.5rem}.mt-6{margin-top:2rem}
    .rep-box{border:1px dashed #ddd; padding:1.25rem; border-radius:6px; margin-bottom:1rem; background:#fafafa}
    pre.preview{white-space:pre-wrap; background:#0f1221; color:#e6edf3; padding:1.5rem; border-radius:8px; max-height:500px; overflow:auto}
    .step{display:inline-block; width:1.8rem; height:1.8rem; line-height:1.8rem; border-radius:50%; text-align:center; background:#485fc7; color:#fff; font-weight:700; margin-right:.5rem}
    .box h2 .step{position:relative; top:-2px}
    .section .container{max-width:1200px}
    
    /* Even more spacious boxes */
    .box {
      padding: 2.5rem;
      margin-bottom: 2rem;
    }
    
    /* Better field spacing */
    .field:not(:last-child) {
      margin-bottom: 1.5rem;
    }
    
    /* Section headers with more space */
    .section-header {
      font-weight: 700;
      font-size: 1.15rem;
      margin-bottom: 1.25rem;
      margin-top: 1.75rem;
      padding-bottom: 0.65rem;
      border-bottom: 2px solid #dbdbdb;
    }
    
    .section-header:first-child {
      margin-top: 0;
    }
    
    /* Help text styling */
    .help {
      font-size: 0.875rem;
      line-height: 1.5;
      margin-top: 0.4rem;
    }
    
    .help-box {
      background: #f5f5f5;
      border-left: 3px solid #3273dc;
      padding: 1rem 1.25rem;
      margin-top: 0.65rem;
      margin-bottom: 0.65rem;
      font-size: 0.875rem;
      line-height: 1.6;
    }
    
    /* Better sample boxes */
    .sample-box {
      border: 2px solid #e8e8e8;
      border-radius: 8px;
      padding: 1.75rem;
      margin-bottom: 1.25rem;
      background: #fafafa;
    }
    
    .sample-box .columns {
      margin-bottom: 0.75rem;
    }
    
    /* Input group spacing */
    .input-group {
      margin-bottom: 2rem;
    }
    
    /* Better checkbox styling */
    .checkbox {
      margin-right: 1.25rem;
      font-size: 0.95rem;
    }
    
    .radio {
      font-size: 0.95rem;
      margin-right: 1rem;
    }
    
    /* Column spacing */
    .columns {
      margin-bottom: 1rem;
    }
  </style>
</head>
<body>
<section class="section">
  <div class="container">

    <!-- TITLE -->
    <h1 class="title is-3">TrackTx Configuration Generator</h1>
    <p class="subtitle is-6">
      Build <span class="mono">params.yaml</span> and <span class="mono">samplesheet.csv</span> for the TrackTx PRO-seq pipeline.
      This tool walks you through all options with clear explanations.
    </p>

    <!-- INTRO -->
    <article class="message is-info">
      <div class="message-body">
        <strong>üì¶ What you'll get:</strong> A ZIP file with <span class="mono">params.yaml</span> (pipeline settings) and <span class="mono">samplesheet.csv</span> (your samples).<br>
        <strong>üöÄ How to run:</strong>
        <ol class="mt-2 ml-4">
          <li>Fill out the sections below ‚Üí Click <strong>Download ZIP</strong></li>
          <li>Unzip in your project folder</li>
          <li>Run: <code class="mono">./run_pipeline.sh</code> (recommended) or <code class="mono">nextflow run main.nf -entry TrackTx -profile docker -params-file params.yaml</code></li>
        </ol>
        <strong>‚ú® Statistical divergent transcription detection:</strong> Uses Gaussian Mixture Models and FDR control. No manual threshold tuning needed.
      </div>
    </article>

    <!-- ================================================================ -->
    <!-- STEP 1: PROJECT INFO -->
    <!-- ================================================================ -->
    <div class="box">
      <h2 class="subtitle is-4"><span class="step">1</span> Project Information</h2>
      <p class="mb-4">Basic information about your experiment. These values appear in reports and filenames.</p>
      
      <div class="columns">
        <div class="column">
          <div class="field">
            <label class="label">Project Name</label>
            <input class="input" id="project_name" value="TrackTx_Analysis" placeholder="e.g., HeatShock_TimeCourse">
            <p class="help">A descriptive name for your experiment. Used in reports and output folders.</p>
          </div>
        </div>
        <div class="column">
          <div class="field">
            <label class="label">Output Directory</label>
            <input class="input" id="output_dir" value="./results" placeholder="./results">
            <p class="help">Where all results, figures, and reports will be saved. Can be relative or absolute path.</p>
          </div>
        </div>
      </div>

      <div class="columns">
        <div class="column">
          <div class="field">
            <label class="label">Samplesheet Filename</label>
            <input class="input" id="samplesheet_name" value="samplesheet.csv">
            <p class="help">Name of the CSV file that will list your samples (included in the ZIP).</p>
          </div>
        </div>
        <div class="column">
          <div class="field">
            <label class="label">Control Condition Label</label>
            <input class="input" id="control_label" value="Control" placeholder="Control">
            <p class="help">The condition name used as baseline for spike-in normalization. Should match your sample conditions.</p>
          </div>
        </div>
      </div>

      <div class="columns">
        <div class="column">
          <div class="field">
            <label class="label">Genome Cache Directory</label>
            <input class="input" id="genome_cache" value="./.cache/genomes">
            <p class="help">Pipeline caches reference genomes here for faster re-runs. First run downloads; subsequent runs reuse.</p>
          </div>
        </div>
        <div class="column">
          <div class="field">
            <label class="label">Assets Directory</label>
            <input class="input" id="assets_dir" value="./assets">
            <p class="help">Directory for pipeline temporary files and placeholder files.</p>
          </div>
        </div>
      </div>
      
      <div class="field">
        <label class="checkbox">
          <input type="checkbox" id="yaml_comments" checked>
          Add helpful comments to the YAML file
        </label>
      </div>
    </div>

    <!-- ================================================================ -->
    <!-- STEP 2: SEQUENCING SETUP -->
    <!-- ================================================================ -->
    <div class="box">
      <h2 class="subtitle is-4"><span class="step">2</span> Sequencing Setup</h2>
      <p class="mb-4">Tell us about your sequencing data format and source.</p>
      
      <div class="columns">
        <div class="column">
          <div class="field">
            <label class="label">Read Type</label>
            <div class="control">
              <label class="radio">
                <input type="radio" name="read_type" value="SE" checked>
                <strong>Single-End</strong> (R1 only)
              </label>
              <p class="help is-dim ml-5">One FASTQ file per sample. Most PRO-seq is single-end.</p>
            </div>
            <div class="control mt-2">
              <label class="radio">
                <input type="radio" name="read_type" value="PE">
                <strong>Paired-End</strong> (R1 + R2)
              </label>
              <p class="help is-dim ml-5">Two FASTQ files per sample. Less common for PRO-seq.</p>
            </div>
          </div>
        </div>
        
        <div class="column">
          <div class="field">
            <label class="label">Data Source</label>
            <div class="control">
              <label class="radio">
                <input type="radio" name="sample_source" value="srr" checked>
                <strong>Download from SRA</strong> (enter SRR IDs)
              </label>
              <p class="help is-dim ml-5">Pipeline downloads FASTQ files automatically using SRR accessions.</p>
            </div>
            <div class="control mt-2">
              <label class="radio">
                <input type="radio" name="sample_source" value="local">
                <strong>Local FASTQ files</strong> (enter file paths)
              </label>
              <p class="help is-dim ml-5">Use FASTQ files you already have on your system.</p>
            </div>
          </div>
        </div>
      </div>
      
      <!-- SRA Options -->
      <div id="sraOptions" style="display:none" class="mt-4">
        <div class="section-header">SRA Download Options</div>
        <div class="columns">
          <div class="column">
            <div class="field">
              <label class="checkbox">
                <input type="checkbox" id="fastq_gzip">
                Compress downloaded FASTQs with gzip
              </label>
              <p class="help">Saves disk space but increases download time. Useful for large datasets.</p>
            </div>
          </div>
          <div class="column">
            <div class="field">
              <label class="label">Temporary Directory (optional)</label>
              <input class="input" id="sra_tmp" placeholder="Leave blank to use work directory">
              <p class="help">Where fasterq-dump stores temporary files. Leave blank for default.</p>
            </div>
          </div>
          <div class="column">
            <div class="field">
              <label class="label">Max Prefetch Size</label>
              <input class="input small-input" id="sra_max_size" value="200G">
              <p class="help">Maximum size to prefetch from SRA (e.g., 200G, 500G).</p>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- ================================================================ -->
    <!-- STEP 3: REFERENCE GENOMES -->
    <!-- ================================================================ -->
    <div class="box">
      <h2 class="subtitle is-4"><span class="step">3</span> Reference Genomes & Annotation</h2>
      <p class="mb-4">Select your reference genome and optional spike-in control.</p>
      
      <div class="columns">
        <div class="column">
          <div class="field">
            <label class="label">Primary Reference Genome</label>
            <div class="select">
              <select id="ref_genome" onchange="toggleOtherGenomeUpload('ref')">
                <option value="hs1">Human (T2T-CHM13 / hs1) - Latest complete genome</option>
                <option value="hg38">Human (GRCh38 / hg38) - Standard reference</option>
                <option value="mm10">Mouse (GRCm38 / mm10)</option>
                <option value="dm6">Drosophila (dm6)</option>
                <option value="TAIR10">Arabidopsis (TAIR10)</option>
                <option value="other">Custom genome (provide FASTA + GTF)</option>
              </select>
            </div>
            <p class="help">For common genomes, the pipeline auto-downloads annotations from Ensembl.</p>
          </div>
          
          <div id="refGenomeUpload" style="display:none" class="mt-3">
            <div class="field">
              <label class="label">Custom Genome FASTA</label>
              <input class="input" type="text" id="ref_genome_path" placeholder="/path/to/genome.fa or genome.fa.gz">
              <p class="help">Full path to your genome FASTA file (gzipped OK).</p>
            </div>
          </div>
        </div>
        
        <div class="column">
          <div class="field">
            <label class="label">Spike-in Genome (optional)</label>
            <div class="select">
              <select id="spike_genome" onchange="toggleOtherGenomeUpload('spike')">
                <option value="None" selected>None - no spike-in normalization</option>
                <option value="dm6">Drosophila (dm6) - common for mammalian experiments</option>
                <option value="mm10">Mouse (GRCm38 / mm10)</option>
                <option value="ERCC">ERCC mix - synthetic spike-in</option>
                <option value="other">Custom spike-in (provide FASTA)</option>
              </select>
            </div>
            <p class="help">Spike-in enables quantitative normalization across samples. Requires adding spike-in to your library prep.</p>
          </div>
          
          <div id="spikeGenomeUpload" style="display:none" class="mt-3">
            <div class="field">
              <label class="label">Custom Spike-in FASTA</label>
              <input class="input" type="text" id="spikein_genome_path" placeholder="/path/to/spikein.fa or spikein.fa.gz">
              <p class="help">Full path to spike-in genome FASTA file.</p>
            </div>
          </div>
        </div>
      </div>
      
      <!-- GTF for custom genome -->
      <div id="gtfBlock" style="display:none" class="mt-4">
        <div class="section-header">Gene Annotation (GTF) for Custom Genome</div>
        <div class="help-box">
          <strong>Required for custom genomes:</strong> Provide either a local GTF file path OR a download URL. 
          The pipeline uses this to identify genes, TSS, and TES positions. Gzipped GTF files are supported.
        </div>
        <div class="columns mt-3">
          <div class="column">
            <div class="field">
              <label class="label">GTF File Path (preferred)</label>
              <input class="input" type="text" id="gtf_path" placeholder="/path/to/annotations.gtf or .gtf.gz">
              <p class="help">Local path to your GTF annotation file.</p>
            </div>
          </div>
          <div class="column">
            <div class="field">
              <label class="label">GTF URL (alternative)</label>
              <input class="input" type="text" id="gtf_url" placeholder="https://server.com/annotations.gtf.gz">
              <p class="help">URL to download GTF from. If both path and URL provided, path takes priority.</p>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- ================================================================ -->
    <!-- STEP 4: SAMPLES -->
    <!-- ================================================================ -->
    <div class="box">
      <h2 class="subtitle is-4"><span class="step">4</span> Sample Information</h2>
      <p class="mb-4">Add your samples and replicates. Each replicate becomes one row in the samplesheet CSV.</p>
      
      <div class="help-box mb-4">
        <strong>üí° Tips:</strong>
        <ul class="ml-4 mt-2">
          <li>Include at least 2 biological replicates per condition for statistical power</li>
          <li>Sample names become <code>SampleName_r1</code>, <code>SampleName_r2</code>, etc.</li>
          <li>For spike-in normalization: name control samples "Control" at timepoint "0"</li>
          <li>Treatment and timepoint are optional but helpful for organizing results</li>
        </ul>
      </div>
      
      <div id="samplesContainer"></div>
      
      <div class="buttons mt-3">
        <button type="button" class="button is-link" onclick="addSampleUI()">
          ‚ûï Add Sample
        </button>
        <button type="button" class="button is-danger is-light" onclick="clearSamples()">
          üóëÔ∏è Clear All Samples
        </button>
      </div>
    </div>

    <!-- ================================================================ -->
    <!-- STEP 5: READ PROCESSING -->
    <!-- ================================================================ -->
    <div class="box">
      <h2 class="subtitle is-4"><span class="step">5</span> Read Processing & Quality Control</h2>
      <p class="mb-4">Configure how raw sequencing reads are cleaned and prepared for alignment.</p>
      
      <!-- Adapter Trimming Section -->
      <div class="section-header">Adapter Trimming</div>
      <div class="help-box mb-3">
        <strong>What is adapter trimming?</strong> Removes sequencing adapters that can interfere with alignment. 
        Recommended for nearly all libraries unless you've already trimmed adapters.
      </div>
      
      <div class="field">
        <label class="checkbox">
          <input type="checkbox" id="enableAdapters" checked onchange="toggleAdapterFields()">
          <strong>Enable adapter trimming</strong> (uses cutadapt)
        </label>
      </div>
      
      <div id="adapterFields" class="mt-4">
        <div class="columns">
          <div class="column is-one-third">
            <div class="field">
              <label class="label">Adapter Preset</label>
              <div class="select">
                <select id="adapterPreset" onchange="setAdapterPreset()">
                  <option value="illumina" selected>Illumina Universal</option>
                  <option value="nextera">Nextera</option>
                  <option value="custom">Custom sequences (edit below)</option>
                </select>
              </div>
              <p class="help">Preset fills the adapter sequences automatically. Most libraries use Illumina Universal.</p>
            </div>
          </div>
          <div class="column">
            <div class="field">
              <label class="label">Adapter 1 (R1)</label>
              <input class="input mono" id="adapter1" placeholder="Adapter sequence">
              <p class="help">The adapter sequence that may appear at the 3' end of R1 reads.</p>
            </div>
          </div>
          <div class="column" id="adapter2Field" style="display:none">
            <div class="field">
              <label class="label">Adapter 2 (R2, paired-end only)</label>
              <input class="input mono" id="adapter2" placeholder="Adapter sequence">
              <p class="help">The adapter sequence for R2 reads (only for paired-end mode).</p>
            </div>
          </div>
        </div>
        
        <div class="field mt-3">
          <label class="label">Cutadapt Extra Options (advanced)</label>
          <input class="input" id="cutadapt_extra" placeholder="--minimum-length=20 --quality-cutoff=15">
          <p class="help">Additional command-line flags for cutadapt. Leave blank if unsure. Default settings work well for most cases.</p>
        </div>
      </div>
      
      <!-- Quality Control Section -->
      <div class="section-header mt-5">Quality Control (FastQC)</div>
      <div class="help-box mb-3">
        <strong>What is FastQC?</strong> Industry-standard tool that generates HTML reports showing read quality, 
        adapter content, GC bias, and other metrics. Highly recommended to assess data quality.
      </div>
      
      <div class="columns">
        <div class="column">
          <div class="field">
            <label class="checkbox">
              <input type="checkbox" id="qc_enabled" checked>
              <strong>Generate FastQC reports</strong>
            </label>
            <p class="help">Creates detailed HTML quality reports for each sample.</p>
          </div>
        </div>
        <div class="column">
          <div class="field">
            <label class="checkbox">
              <input type="checkbox" id="qc_raw" checked>
              <strong>QC on raw reads</strong> (before processing)
            </label>
            <p class="help">Run FastQC on the original reads to see initial quality before any trimming.</p>
          </div>
        </div>
      </div>
      
      <!-- UMI Section -->
      <div class="section-header mt-6"><strong>UMI</strong> (Unique Molecular Identifiers)</div>
      <div class="help-box mb-4">
        <strong>What are UMIs?</strong> Random barcodes (typically 6-12 bases) added during library prep to tag individual molecules before PCR. 
        UMIs allow removal of PCR duplicates while retaining biological duplicates, improving quantification accuracy. 
        <strong>Many modern PRO-seq protocols include UMIs</strong> - check your library prep protocol or sequencing provider documentation.
        If present, UMIs are typically at the 5' end of reads.
      </div>
      
      <div class="field">
        <label class="checkbox">
          <input type="checkbox" id="enableUMI" onchange="toggleBlock('umiOptions')">
          My library has UMIs
        </label>
      </div>
      
      <div id="umiOptions" style="display:none" class="mt-4">
        <div class="columns">
          <div class="column is-one-quarter">
            <div class="field">
              <label class="label">UMI Length (bases)</label>
              <input class="input small-input" id="umi_length" type="number" min="1" max="20" value="8">
              <p class="help">Number of bases in the UMI. Typical: 6-10 bases. Check your library prep protocol.</p>
            </div>
          </div>
          <div class="column">
            <div class="field">
              <label class="label">UMI Location</label>
              <div class="control">
                <label class="radio">
                  <input type="radio" name="umi_end" value="5" checked> 5' end (start of read)
                </label>
                <label class="radio">
                  <input type="radio" name="umi_end" value="3"> 3' end (end of read)
                </label>
              </div>
              <p class="help">PRO-seq UMIs are typically at the 5' end. Check your protocol if unsure.</p>
            </div>
          </div>
        </div>
      </div>
      
      <!-- Barcode Section -->
      <div class="section-header mt-6"><strong>Sample Barcodes</strong> (Multiplexing)</div>
      <div class="help-box mb-4">
        <strong>What are barcodes?</strong> Fixed sequences (typically 6-8 bases) used to identify different samples in a multiplexed sequencing run.
        <strong>PRO-seq commonly uses in-read barcodes</strong> in addition to or instead of Illumina's index reads (i5/i7). 
        Enable this if your barcodes are part of the actual read sequence (not just in the index reads). 
        Check your library prep protocol - if you multiplexed samples with inline barcodes, you'll need to enable this and specify the barcode length and location.
      </div>
      
      <div class="field">
        <label class="checkbox">
          <input type="checkbox" id="enableBarcode" onchange="toggleBlock('barcodeOptions')">
          My library has in-read barcodes
        </label>
      </div>
      
      <div id="barcodeOptions" style="display:none" class="mt-4">
        <div class="columns">
          <div class="column is-one-quarter">
            <div class="field">
              <label class="label">Barcode Length (bases)</label>
              <input class="input small-input" id="barcode_length" type="number" min="1" max="20" value="6">
              <p class="help">Number of bases in the inline barcode. Typical: 6-8 bases. Verify with your library prep documentation.</p>
            </div>
          </div>
          <div class="column">
            <div class="field">
              <label class="label">Barcode Location</label>
              <div class="control">
                <label class="radio">
                  <input type="radio" name="barcode_end" value="5" checked> 5' end (start of read)
                </label>
                <label class="radio">
                  <input type="radio" name="barcode_end" value="3"> 3' end (end of read)
                </label>
              </div>
              <p class="help">Most inline barcodes are at the 5' end. If you also have UMIs, the barcode typically comes after the UMI.</p>
            </div>
          </div>
        </div>
      </div>
      
      <!-- Bowtie2 options -->
      <div class="section-header mt-5">Alignment Settings</div>
      <div class="field">
        <label class="label">Bowtie2 Extra Options (advanced)</label>
        <input class="input" id="bowtie2_extra" placeholder="--very-sensitive">
        <p class="help">Additional command-line flags for Bowtie2 aligner. Default settings are optimized for PRO-seq. Leave blank unless you have specific requirements.</p>
      </div>
    </div>

    <!-- ================================================================ -->
    <!-- STEP 6: ANALYSIS PARAMETERS -->
    <!-- ================================================================ -->
    <div class="box">
      <h2 class="subtitle is-4"><span class="step">6</span> Analysis Parameters</h2>
      <p class="mb-4">Configure computational analysis settings. Default values are optimized for PRO-seq.</p>
      
      <!-- Divergent Transcription -->
      <div class="section-header"><strong>Divergent Transcription Detection</strong> (statistical)</div>
      <div class="help-box mb-3">
        <strong>What is divergent transcription?</strong> Bidirectional transcription from promoters and enhancers, 
        where RNA Polymerase II initiates in both directions. This is a hallmark of active regulatory elements.
        <br><br>
        <strong>Statistical engine:</strong> Uses Gaussian Mixture Models with FDR control for detection. 
        <strong>Set thresholds to "auto" for automatic calibration</strong> - the algorithm will find optimal 
        values from your data's background distribution. No manual tuning needed!
      </div>
      
      <div class="columns">
        <div class="column">
          <div class="field">
            <label class="label">Threshold</label>
            <input class="input small-input" id="div_thr" value="auto" placeholder="auto or number">
            <p class="help">
              <strong>Per-bin signal minimum.</strong><br>
              ‚Ä¢ <code>auto</code> = 95th percentile of background (recommended)<br>
              ‚Ä¢ Or specify a number (e.g., 1.0, 2.0)
            </p>
          </div>
        </div>
        <div class="column">
          <div class="field">
            <label class="label">Sum Threshold</label>
            <input class="input small-input" id="div_sum" value="auto" placeholder="auto or number">
            <p class="help">
              <strong>Minimum total signal for peaks.</strong><br>
              ‚Ä¢ <code>auto</code> = 10√ó threshold (recommended)<br>
              ‚Ä¢ Or specify a number (e.g., 5.0, 10.0)
            </p>
          </div>
        </div>
        <div class="column">
          <div class="field">
            <label class="label">FDR (False Discovery Rate)</label>
            <input class="input small-input" id="div_fdr" type="number" step="0.01" min="0.001" max="0.5" value="0.05">
            <p class="help">
              <strong>Statistical stringency.</strong><br>
              ‚Ä¢ 0.05 = 5% expected false positives (standard)<br>
              ‚Ä¢ Lower (0.01) = fewer, higher-confidence regions<br>
              ‚Ä¢ Higher (0.10) = more sensitive, more regions
            </p>
          </div>
        </div>
      </div>
      
      <div class="columns mt-3">
        <div class="column">
          <div class="field">
            <label class="label">Pairing Window (bp)</label>
            <input class="input small-input" id="div_win" type="number" min="1" value="1000">
            <p class="help">
              <strong>Max distance for pairing peaks on opposite strands.</strong><br>
              Typical: 500-2000 bp. Larger = more permissive pairing.
            </p>
          </div>
        </div>
        <div class="column">
          <div class="field">
            <label class="label">Bin Gap (bp)</label>
            <input class="input small-input" id="div_bin_gap" type="number" min="0" value="100">
            <p class="help">
              <strong>Max gap to merge consecutive bins into peaks.</strong><br>
              Typical: 50-200 bp. Allows small gaps within peaks.
            </p>
          </div>
        </div>
        <div class="column">
          <div class="field">
            <label class="label">Balance Ratio</label>
            <input class="input small-input" id="div_bal" type="number" step="0.05" min="0" max="1" value="0">
            <p class="help">
              <strong>Minimum balance between strand signals.</strong><br>
              ‚Ä¢ 0.0 = no filter (max sensitivity, recommended)<br>
              ‚Ä¢ 0.3-0.5 = require balanced signals
            </p>
          </div>
        </div>
        <div class="column">
          <div class="field">
            <label class="label">QC Report</label>
            <label class="checkbox mt-2">
              <input type="checkbox" id="div_qc" checked>
              Generate statistical QC report
            </label>
            <p class="help">Creates TXT report with score distributions and feature summaries.</p>
          </div>
        </div>
      </div>
      
      <!-- Functional Regions -->
      <div class="section-header mt-5"><strong>Functional Region Definitions</strong></div>
      <div class="help-box mb-3">
        <strong>What are functional regions?</strong> Genomic features used for Pol-II metrics calculation:
        promoters (TSS ¬± window), gene bodies, termination windows, etc. These values define the boundaries 
        for measuring transcription activity.
      </div>
      
      <div class="columns">
        <div class="column">
          <div class="field">
            <label class="label">Promoter Upstream (bp)</label>
            <input class="input small-input" id="prom_up" type="number" value="500">
            <p class="help">Distance upstream of TSS to include in promoter region. Common: 250-1000 bp.</p>
          </div>
        </div>
        <div class="column">
          <div class="field">
            <label class="label">Promoter Downstream (bp)</label>
            <input class="input small-input" id="prom_down" type="number" value="250">
            <p class="help">Distance downstream of TSS to include in promoter. Common: 250-500 bp.</p>
          </div>
        </div>
        <div class="column">
          <div class="field">
            <label class="label">Gene Body Start Offset (bp)</label>
            <input class="input small-input" id="gb_start_offset" type="number" value="2000">
            <p class="help">Where gene body region starts after TSS. Excludes promoter-proximal pausing region.</p>
          </div>
        </div>
      </div>
      
      <div class="columns mt-3">
        <div class="column">
          <div class="field">
            <label class="label">CPS Offset (bp)</label>
            <input class="input small-input" id="cps_offset" type="number" value="50">
            <p class="help">Window around cleavage/polyadenylation site. Common: 50-500 bp.</p>
          </div>
        </div>
        <div class="column">
          <div class="field">
            <label class="label">Termination Window (bp)</label>
            <input class="input small-input" id="tw_length" type="number" value="5000">
            <p class="help">Region after gene end to capture termination. Common: 5,000-10,000 bp.</p>
          </div>
        </div>
        <div class="column">
          <div class="field">
            <label class="label">Merge Gap (bp)</label>
            <input class="input small-input" id="merge_gap" type="number" value="50">
            <p class="help">Max gap to merge nearby features. Common: 50-100 bp.</p>
          </div>
        </div>
        <div class="column">
          <div class="field">
            <label class="label">QC Summary</label>
            <label class="checkbox mt-2">
              <input type="checkbox" id="fgr_qc" checked>
              Generate region QC
            </label>
            <p class="help">Create summary of assigned reads per region type.</p>
          </div>
        </div>
      </div>
    </div>

    <!-- ================================================================ -->
    <!-- STEP 7: OUTPUT PREFERENCES -->
    <!-- ================================================================ -->
    <div class="box">
      <h2 class="subtitle is-4"><span class="step">7</span> Output Preferences</h2>
      <p class="mb-4">Control which outputs are generated and in which formats.</p>
      
      <div class="section-header">Track Normalization</div>
      <div class="help-box mb-3">
        <strong>CPM:</strong> Counts Per Million - normalizes for library size differences.<br>
        <strong>siCPM:</strong> Spike-in CPM - quantitative normalization using spike-in controls. Requires spike-in genome and proper controls.
      </div>
      
      <div class="columns">
        <div class="column">
          <label class="checkbox">
            <input type="checkbox" id="outputCPM" checked>
            <strong>Generate CPM-normalized tracks</strong>
          </label>
          <p class="help">Recommended. Normalizes for sequencing depth across samples.</p>
        </div>
        <div class="column">
          <label class="checkbox">
            <input type="checkbox" id="outputSiCPM" checked>
            <strong>Generate siCPM (spike-in normalized)</strong>
          </label>
          <p class="help">Only works if you selected a spike-in genome and have proper controls.</p>
        </div>
        <div class="column">
          <label class="checkbox">
            <input type="checkbox" id="outputRawTracks">
            <strong>Keep raw (unnormalized) tracks</strong>
          </label>
          <p class="help">Optional. Saves disk space if unchecked.</p>
        </div>
      </div>
      
      <div class="section-header mt-4">Track Formats</div>
      <div class="help-box mb-3">
        <strong>BigWig (.bw):</strong> Compressed binary format, fast loading in genome browsers (recommended).<br>
        <strong>BedGraph (.bedgraph):</strong> Text format, larger files but human-readable.
      </div>
      
      <div class="columns">
        <div class="column">
          <label class="checkbox">
            <input type="checkbox" id="trackBigWig" checked>
            <strong>BigWig format</strong> (recommended)
          </label>
          <p class="help">Compressed, fast loading in UCSC/IGV genome browsers.</p>
        </div>
        <div class="column">
          <label class="checkbox">
            <input type="checkbox" id="trackBedGraph">
            <strong>BedGraph format</strong>
          </label>
          <p class="help">Text format, useful for custom processing or debugging.</p>
        </div>
      </div>
      
      <div class="section-header mt-4">Advanced Output Options</div>
      <div class="columns">
        <div class="column">
          <label class="checkbox">
            <input type="checkbox" id="normEmitBW" checked>
            Emit BigWig from normalizer
          </label>
        </div>
        <div class="column">
          <label class="checkbox">
            <input type="checkbox" id="normEmitSiCPM" checked>
            Emit siCPM (if factors available)
          </label>
        </div>
        <div class="column">
          <label class="checkbox">
            <input type="checkbox" id="normEmitAllMap" checked>
            Emit allMap (multimapper) tracks
          </label>
        </div>
      </div>
      
      <div class="columns mt-3">
        <div class="column is-half">
          <label class="checkbox">
            <input type="checkbox" id="normForce5p">
            Force 5‚Ä≤ track generation (otherwise automatic)
          </label>
          <p class="help">PRO-seq primarily uses 3' signal. 5' is optional.</p>
        </div>
        <div class="column is-half">
          <label class="checkbox">
            <input type="checkbox" id="forceSortBg">
            Force sort bedGraphs before BigWig conversion
          </label>
          <p class="help">Enable if UCSC tools complain about sort order. Slower but safer.</p>
        </div>
      </div>
    </div>

    <!-- ================================================================ -->
    <!-- STEP 8: BUILD & DOWNLOAD -->
    <!-- ================================================================ -->
    <div class="box">
      <h2 class="subtitle is-4"><span class="step">8</span> Build & Download</h2>
      <p class="mb-4">Generate your configuration files and download them as a ZIP package.</p>
      
      <div class="buttons">
        <button class="button is-primary is-large" onclick="downloadZip()">
          üì¶ Download ZIP (params.yaml + samplesheet.csv)
        </button>
        <button class="button is-light" onclick="fillPreview()">
          üëÅÔ∏è Preview YAML
        </button>
        <button class="button is-light" onclick="copyYAML()">
          üìã Copy YAML to Clipboard
        </button>
      </div>
      
      <div class="mt-4">
        <h3 class="subtitle is-6">YAML Preview</h3>
        <pre class="preview mono" id="yamlPreview">(click "Preview YAML" to see it here)</pre>
      </div>
      
      <div class="mt-4">
        <h3 class="subtitle is-6">How to Run After Download</h3>
        <div class="help-box">
          <strong>Step 1:</strong> Unzip the downloaded file in your project directory<br>
          <strong>Step 2:</strong> Open terminal in that directory<br>
          <strong>Step 3:</strong> Run one of these commands:
        </div>
        <pre class="preview mono mt-2"># Smart helper script (auto-detects environment):
./run_pipeline.sh

# Or run directly with Nextflow:
nextflow run main.nf -entry TrackTx -profile docker -params-file params.yaml

# With monitoring:
nextflow run main.nf -entry TrackTx -profile docker -params-file params.yaml -with-report report.html</pre>
      </div>
    </div>

  </div>
</section>

<script>
/* ====================== Utilities ====================== */
const $  = sel => document.querySelector(sel);
const $$ = sel => Array.from(document.querySelectorAll(sel));
const mono = s => s == null ? 'null' : `"${String(s).replace(/"/g,'\\"')}"`;
const isPE = () => document.querySelector('input[name="read_type"]:checked').value === 'PE';
const source = () => document.querySelector('input[name="sample_source"]:checked').value;

/* ====================== UI Toggles ====================== */
function toggleBlock(id, show){
  const el = document.getElementById(id);
  if(!el) return;
  el.style.display = (show === undefined) ? (el.style.display==='none'?'block':'none') : (show?'block':'none');
}

function toggleOtherGenomeUpload(kind){
  if(kind==='ref'){
    const show = ($('#ref_genome').value === 'other');
    toggleBlock('refGenomeUpload', show);
    toggleBlock('gtfBlock', show);
  } else if(kind==='spike'){
    toggleBlock('spikeGenomeUpload', $('#spike_genome').value === 'other');
  }
}

function toggleAdapterFields(){
  const use = $('#enableAdapters').checked;
  toggleBlock('adapterFields', use);
  if(use) setAdapterPreset();
}

function setAdapterPreset(){
  const preset = $('#adapterPreset')?.value || '';
  $('#adapter2Field').style.display = isPE() ? 'block' : 'none';
  if(preset==='illumina'){
    $('#adapter1').value='TGGAATTCTCGGGTGCCAAGG';
    if(isPE()) $('#adapter2').value='GATCGTCGGACTGTAGAACTCTGAAC';
  }else if(preset==='nextera'){
    $('#adapter1').value='CTGTCTCTTATACACATCT';
    if(isPE()) $('#adapter2').value='CTGTCTCTTATACACATCT';
  }
}

function toggleSraOptions(){
  const show = (source() === 'srr');
  toggleBlock('sraOptions', show);
}

/* ====================== Samples UI ====================== */
function replicateHTML(){
  const src = source();
  const pe  = isPE();
  if(src==='local'){
    return `
      <div class="rep-box replicate">
        <div class="is-pulled-right">
          <button class="button is-white is-small" onclick="this.closest('.replicate').remove()" title="Remove replicate">‚úï</button>
        </div>
        <strong>Replicate</strong>
        <div class="columns mt-2">
          <div class="column">
            <input class="input rep-file1" placeholder="/full/path/to/R1.fastq or R1.fastq.gz">
            <p class="help">Full path to R1 FASTQ file (gzipped OK)</p>
          </div>
          ${pe?'<div class="column"><input class="input rep-file2" placeholder="/full/path/to/R2.fastq or R2.fastq.gz"><p class="help">Full path to R2 FASTQ file</p></div>':''}
        </div>
      </div>`;
  }else{
    return `
      <div class="rep-box replicate">
        <div class="is-pulled-right">
          <button class="button is-white is-small" onclick="this.closest('.replicate').remove()" title="Remove replicate">‚úï</button>
        </div>
        <strong>Replicate</strong>
        <div class="columns mt-2">
          <div class="column">
            <input class="input rep-srr" placeholder="SRR12345678">
            <p class="help">Enter SRR accession (e.g., SRR12345678)</p>
          </div>
        </div>
      </div>`;
  }
}

function addReplicateUI(sampleBox){
  const reps = sampleBox.querySelector('.replicates');
  reps.insertAdjacentHTML('beforeend', replicateHTML());
}

function refreshSampleBoxUI(sampleBox){
  const reps = sampleBox.querySelector('.replicates');
  const n = Math.max(1, reps.children.length);
  reps.innerHTML = '';
  for(let i=0;i<n;i++) addReplicateUI(sampleBox);
}

function addSampleUI(){
  const box = document.createElement('div');
  box.className = 'sample-box';
  box.innerHTML = `
    <div class="is-pulled-right">
      <button class="button is-danger is-light is-small" onclick="this.closest('.sample-box').remove()">Delete Sample</button>
    </div>
    <div class="columns">
      <div class="column is-3">
        <label class="label">Sample Name</label>
        <input class="input sample-name" placeholder="e.g., Heat_Treatment">
        <p class="help">Base name for this sample (becomes Sample_r1, Sample_r2, etc.)</p>
      </div>
      <div class="column is-3">
        <label class="label">Treatment (optional)</label>
        <input class="input sample-treatment" placeholder="e.g., heat_shock">
        <p class="help">Experimental condition or treatment</p>
      </div>
      <div class="column is-2">
        <label class="label">Timepoint (optional)</label>
        <input class="input sample-timepoint" placeholder="e.g., 30min">
        <p class="help">Time value with unit (e.g., 0, 30min, 2h)</p>
      </div>
      <div class="column is-4">
        <label class="label">Replicates</label>
        <button class="button is-small is-link is-light" onclick="addReplicateUI(this.closest('.sample-box'))">
          ‚ûï Add Replicate
        </button>
      </div>
    </div>
    <div class="replicates mt-2"></div>
  `;
  $('#samplesContainer').appendChild(box);
  addReplicateUI(box);
  addReplicateUI(box);
}

function clearSamples(){ 
  if(confirm('Remove all samples?')){
    $('#samplesContainer').innerHTML=''; 
  }
}

function rebuildAllReplicateUIs(){
  $$('#samplesContainer .sample-box').forEach(refreshSampleBoxUI);
  setAdapterPreset();
  toggleSraOptions();
}

/* ====================== YAML Builder ====================== */
function buildYAML(){
  const pairedEnd   = isPE();
  const sampleSource= source();
  const projectName = $('#project_name').value || 'TrackTx_Analysis';
  const outputDir   = $('#output_dir').value || './results';
  const genomeCache = $('#genome_cache').value || './.cache/genomes';
  const samplesheet = $('#samplesheet_name').value || 'samplesheet.csv';
  const controlLabel = $('#control_label').value || 'Control';
  const assetsDir   = $('#assets_dir').value || './assets';

  const refGenome   = $('#ref_genome').value;
  const spikeGenome = $('#spike_genome').value;
  const genomeFasta = (refGenome==='other') ? ($('#ref_genome_path').value.trim() || null) : null;
  const spikeFasta  = (spikeGenome==='other') ? ($('#spikein_genome_path').value.trim() || null) : null;

  const gtfPath = (refGenome==='other') ? ($('#gtf_path').value.trim() || '') : '';
  const gtfUrl  = (refGenome==='other') ? ($('#gtf_url').value.trim()  || '') : '';

  const fastqGzip = $('#fastq_gzip').checked;
  const sraTmp = $('#sra_tmp').value.trim() || null;
  const sraMaxSize = $('#sra_max_size').value || '200G';

  const trimOn   = $('#enableAdapters').checked;
  let   preset   = $('#adapterPreset')?.value || '';
  const adapter1 = $('#adapter1')?.value || '';
  let   adapter2 = $('#adapter2')?.value || '';
  if(!pairedEnd) adapter2='';
  if(trimOn && !preset) preset = 'illumina';

  const cutadaptExtra = $('#cutadapt_extra').value || '';
  const bowtie2Extra  = $('#bowtie2_extra').value || '';

  const qcEnabled = !!$('#qc_enabled')?.checked;
  const qcRaw     = !!$('#qc_raw')?.checked;

  const umiOn  = $('#enableUMI').checked;
  const umiLen = umiOn ? parseInt($('#umi_length').value||'8',10) : 0;
  const umiLoc = umiOn ? parseInt(document.querySelector('input[name="umi_end"]:checked')?.value || '5',10) : 5;

  const bcOn  = $('#enableBarcode').checked;
  const bcLen = bcOn ? parseInt($('#barcode_length').value||'6',10) : 0;
  const bcLoc = bcOn ? parseInt(document.querySelector('input[name="barcode_end"]:checked')?.value || '5',10) : 5;

  // Divergent (statistical)
  const divThrVal = $('#div_thr').value.trim();
  const divSumVal = $('#div_sum').value.trim();
  const div = {
    threshold:  (divThrVal === 'auto' || divThrVal === '') ? 'auto' : parseFloat(divThrVal),
    sum_thr:    (divSumVal === 'auto' || divSumVal === '') ? 'auto' : parseFloat(divSumVal),
    fdr:        parseFloat($('#div_fdr').value||'0.05'),
    nt_window:  parseInt($('#div_win').value||'1000',10),
    bin_gap:    parseInt($('#div_bin_gap').value||'100',10),
    balance:    parseFloat($('#div_bal').value||'0') || 0,
    qc:         !!$('#div_qc').checked
  };

  // Functional regions
  const fgr = {
    prom_up:         parseInt($('#prom_up').value||'500',10),
    prom_down:       parseInt($('#prom_down').value||'250',10),
    gb_start_offset: parseInt($('#gb_start_offset').value||'2000',10),
    cps_offset:      parseInt($('#cps_offset').value||'50',10),
    tw_length:       parseInt($('#tw_length').value||'5000',10),
    merge_gap:       parseInt($('#merge_gap').value||'50',10),
    qc:              !!$('#fgr_qc').checked
  };

  // Output switches
  const out = {
    cpm:     $('#outputCPM').checked,
    sicpm:   $('#outputSiCPM').checked,
    raw:     $('#outputRawTracks').checked,
    bigwig:  $('#trackBigWig').checked,
    bedgraph:$('#trackBedGraph').checked
  };

  const normEmitBW     = $('#normEmitBW').checked;
  const normEmitSiCPM  = $('#normEmitSiCPM').checked;
  const normEmitAllMap = $('#normEmitAllMap').checked;
  const normForce5p    = $('#normForce5p').checked;
  const forceSortBg    = $('#forceSortBg').checked;

  // Build YAML
  let y = '';
  if($('#yaml_comments').checked){
    y += '# ============================================================\n';
    y += '# TrackTx Pipeline Configuration\n';
    y += '# Generated: ' + new Date().toISOString() + '\n';
    y += '# How to run:\n';
    y += '#   nextflow run main.nf -entry TrackTx -profile docker -params-file params.yaml\n';
    y += '# ============================================================\n\n';
  }

  y += `experiment_name: ${mono(projectName)}\n`;
  y += `samplesheet: ${mono(samplesheet)}\n`;
  y += `sample_source: ${mono(sampleSource)}\n`;
  y += `paired_end: ${pairedEnd}\n`;
  y += `output_dir: ${mono(outputDir)}\n`;
  y += `control_label: ${mono(controlLabel)}\n\n`;

  y += `# SRA download options\n`;
  y += `fastq_gzip: ${fastqGzip}\n`;
  y += `sra_tmp: ${sraTmp ? mono(sraTmp) : 'null'}\n`;
  y += `sra_max_size: ${mono(sraMaxSize)}\n\n`;

  y += `# Reference genomes\n`;
  y += `reference_genome: ${mono(refGenome)}\n`;
  y += `genome_fasta: ${genomeFasta?mono(genomeFasta):'null'}\n`;
  y += `spikein_genome: ${mono(spikeGenome)}\n`;
  y += `spikein_fasta: ${spikeFasta?mono(spikeFasta):'null'}\n\n`;

  y += `# Directories\n`;
  y += `assets_dir: ${mono(assetsDir)}\n`;
  y += `genome_cache: ${mono(genomeCache)}\n`;
  y += `force_rebuild: false\n\n`;

  if(refGenome==='other'){
    y += `# Custom genome annotation\n`;
    y += `gtf_path: ${mono(gtfPath)}\n`;
    y += `gtf_url: ${mono(gtfUrl)}\n\n`;
  } else {
    y += `gtf_path: ""\n`;
    y += `gtf_url: ""\n\n`;
  }

  y += `# Adapter trimming\n`;
  y += `adapter_trimming:\n`;
  y += `  enabled: ${trimOn}\n`;
  y += `  preset: ${mono(preset)}\n`;
  y += `  adapter1: ${mono(adapter1)}\n`;
  y += `  adapter2: ${mono(adapter2)}\n`;
  y += `  minlen: 12\n\n`;

  y += `# Quality control\n`;
  y += `qc:\n`;
  y += `  enabled: ${qcEnabled}\n`;
  y += `fastqc_raw: ${qcRaw}\n\n`;

  y += `# UMI processing\n`;
  y += `umi:\n`;
  y += `  enabled: ${umiOn}\n`;
  y += `  length: ${umiLen}\n`;
  y += `  location: ${umiLoc}\n\n`;

  y += `# Barcode processing\n`;
  y += `barcode:\n`;
  y += `  enabled: ${bcOn}\n`;
  y += `  length: ${bcLen}\n`;
  y += `  location: ${bcLoc}\n\n`;

  y += `# Output formats\n`;
  y += `output:\n`;
  y += `  cpm: ${out.cpm}\n`;
  y += `  crpmsi: ${out.sicpm}\n`;
  y += `  raw_tracks: ${out.raw}\n`;
  y += `  bigwig: ${out.bigwig}\n`;
  y += `  bedgraph: ${out.bedgraph}\n\n`;

  y += `# Normalization options\n`;
  y += `norm:\n`;
  y += `  emit_bw: ${normEmitBW}\n`;
  y += `  emit_sicpm: ${normEmitSiCPM}\n`;
  y += `  emit_allmap: ${normEmitAllMap}\n`;
  y += `  emit_5p: ${normForce5p ? 'true' : 'null'}\n\n`;

  y += `force_sort_bedgraph: ${forceSortBg}\n\n`;

  y += `# Analysis parameters\n`;
  y += `advanced:\n`;
  y += `  cutadapt_extra: ${mono(cutadaptExtra)}\n`;
  y += `  bowtie2_extra: ${mono(bowtie2Extra)}\n`;
  y += `  # Divergent transcription (statistical with GMM + FDR)\n`;
  y += `  divergent_threshold: ${div.threshold === 'auto' ? 'auto' : div.threshold}  # auto = 95th percentile\n`;
  y += `  divergent_sum_thr: ${div.sum_thr === 'auto' ? 'auto' : div.sum_thr}      # auto = 10x threshold\n`;
  y += `  divergent_fdr: ${div.fdr}          # False discovery rate\n`;
  y += `  divergent_nt_window: ${div.nt_window}     # Pairing window (bp)\n`;
  y += `  divergent_bin_gap: ${div.bin_gap}        # Bin merge gap (bp)\n`;
  y += `  divergent_balance: ${div.balance}        # Balance ratio (0 = max sensitivity)\n`;
  y += `  divergent_qc: ${div.qc}\n\n`;

  y += `# Functional region geometry\n`;
  y += `functional_regions:\n`;
  Object.entries(fgr).forEach(([k,v]) => y += `  ${k}: ${v}\n`);

  return y;
}

/* ====================== CSV Builder ====================== */
function buildCSV(){
  const pe = isPE();
  const src = source();
  let csv = "sample,treatment,timepoint,replicate,file1,file2\n";
  $$('#samplesContainer .sample-box').forEach((box,si)=>{
    const sname = box.querySelector('.sample-name').value || `Sample_${si+1}`;
    const treat = box.querySelector('.sample-treatment').value || '';
    const tpt   = box.querySelector('.sample-timepoint').value || '';
    const reps  = box.querySelectorAll('.replicate');
    reps.forEach((rep,ri)=>{
      const repno = ri+1;
      if(src==='local'){
        const f1 = rep.querySelector('.rep-file1')?.value.trim() || '';
        const f2 = pe ? (rep.querySelector('.rep-file2')?.value.trim() || '') : '';
        csv += `${sname},${treat},${tpt},${repno},${f1},${f2}\n`;
      }else{
        const srr = rep.querySelector('.rep-srr')?.value.trim() || '';
        csv += `${sname},${treat},${tpt},${repno},${srr},\n`;
      }
    });
  });
  return csv;
}

/* ====================== Actions ====================== */
function fillPreview(){
  const y = buildYAML();
  let warn = '';
  if($('#ref_genome').value==='other' && !$('#gtf_path').value.trim() && !$('#gtf_url').value.trim()){
    warn += "\n# WARNING: Custom genome requires gtf_path or gtf_url.\n";
  }
  $('#yamlPreview').textContent = y + warn;
}

async function downloadZip(){
  const zip = new JSZip();
  const yaml = buildYAML();
  const csv  = buildCSV();

  zip.file("params.yaml", yaml);
  zip.file($("#samplesheet_name").value || "samplesheet.csv", csv);

  const blob = await zip.generateAsync({type:"blob"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url; a.download = "TrackTx_Config.zip";
  document.body.appendChild(a); a.click(); a.remove();
  URL.revokeObjectURL(url);
}

function copyYAML(){
  const y = buildYAML();
  navigator.clipboard.writeText(y).then(()=>{
    alert('‚úÖ YAML copied to clipboard!');
  });
}

/* ====================== Init ====================== */
function init(){
  addSampleUI();
  $$('input[name="read_type"]').forEach(r => r.addEventListener('change', rebuildAllReplicateUIs));
  $$('input[name="sample_source"]').forEach(r => r.addEventListener('change', rebuildAllReplicateUIs));
  toggleOtherGenomeUpload('ref');
  toggleOtherGenomeUpload('spike');
  toggleAdapterFields();
  toggleSraOptions();
  setAdapterPreset();
}
init();
</script>
</body>
</html>
