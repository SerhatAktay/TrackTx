// ════════════════════════════════════════════════════════════════════════════
/* SLURM Configuration - Optimized for SLURM-based HPC clusters */
// ════════════════════════════════════════════════════════════════════════════

// Include shared HPC settings
includeConfig 'conf/hpc.config'

process {
  executor = 'slurm'
  
  // SLURM-specific settings
  clusterOptions = [
    '--job-name=tracktx.{hash}',
    '--output=logs/slurm-%j.out',
    '--error=logs/slurm-%j.err',
    '--time={task.time}',
    '--cpus-per-task={task.cpus}',
    '--mem={task.memory}',
    '--partition=compute',  // Adjust based on your cluster
    '--account=default',    // Adjust based on your cluster
    '--mail-type=NONE',     // Set to END,FAIL if you want email notifications
    // '--constraint=avx2',  // Uncomment if your cluster has CPU feature requirements
  ]
  
  // SLURM resource mapping
  cpus   = { task.cpus }
  memory = { task.memory }
  time   = { task.time }
}

// SLURM executor configuration
executor {
  name = 'slurm'
  queueSize = 100
  submitRateLimit = '10/1min'
  
  // SLURM-specific options
  queueStatCommand = 'squeue --format="%.18i %.9P %.8j %.8u %.2t %.10M %.6D %R" --noheader --me'
  killCommand = 'scancel'
  
  // Job monitoring
  pollInterval = '30s'
  submitRateLimit = '10/1min'
  
  // Cleanup
  cleanup = true
}

// SLURM-specific process overrides
process {
  // Override cluster options for specific processes if needed
  withName: /(?i).*fetch_and_build_index.*/ {
    clusterOptions = [
      '--job-name=tracktx-index.{hash}',
      '--output=logs/slurm-%j.out',
      '--error=logs/slurm-%j.err',
      '--time=72:00:00',
      '--cpus-per-task=16',
      '--mem=64G',
      '--partition=compute',
      '--account=default',
      '--mail-type=NONE',
    ]
  }
  
  withName: /(?i).*run_alignment.*/ {
    clusterOptions = [
      '--job-name=tracktx-align.{hash}',
      '--output=logs/slurm-%j.out',
      '--error=logs/slurm-%j.err',
      '--time=48:00:00',
      '--cpus-per-task=12',
      '--mem=48G',
      '--partition=compute',
      '--account=default',
      '--mail-type=NONE',
    ]
  }
}

// SLURM environment setup
params {
  // SLURM-specific paths (adjust for your cluster)
  slurm_logs_dir = "${params.slurm_logs_dir ?: 'logs'}"
  
  // Common SLURM partitions (customize for your cluster)
  slurm_partition = "${params.slurm_partition ?: 'compute'}"
  slurm_account = "${params.slurm_account ?: 'default'}"
  
  // SLURM resource limits
  max_jobs = "${params.max_jobs ?: 50}"
  max_cpus_per_job = "${params.max_cpus_per_job ?: 32}"
}

// Create logs directory if it doesn't exist
if (!new File(params.slurm_logs_dir).exists()) {
  new File(params.slurm_logs_dir).mkdirs()
}
